// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  engineType = "library"
}

datasource db {
  provider = "postgresql"
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  firstName String?
  lastName  String?
  theme     String?  @default("light")
  emailVerified DateTime?
  verificationToken String?
  resetToken        String?
  resetTokenExpiry  DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  folders   Folder[]
  knowledgeCards KnowledgeCard[]
  sectionTemplates SectionTemplate[]

  // Relations pour les Groupes et Partages
  ownedGroups     Group[]          @relation("GroupOwner")
  groupMemberships GroupMember[]
  sharedWithMe    SharedResource[]
  sentInvitations Invitation[]     @relation("SentInvitations")

  @@map("users")
}

model Folder {
  id          String   @id @default(uuid())
  name        String
  userId      String
  parentId    String?
  order       Int      @default(0)
  color       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  parent      Folder?  @relation("FolderTree", fields: [parentId], references: [id], onDelete: Cascade)
  children    Folder[] @relation("FolderTree")
  knowledgeCards KnowledgeCard[]
  shortcuts   CardShortcut[]
  shares      SharedResource[]

  @@map("folders")
  @@index([userId])
  @@index([parentId])
  @@index([userId, parentId, order])
}

model KnowledgeCard {
  id        String   @id @default(uuid())
  title     String
  summary   String?
  userId    String
  folderId  String?
  order     Int      @default(0)
  color     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  folder    Folder?           @relation(fields: [folderId], references: [id], onDelete: SetNull)
  sections  KnowledgeSection[]
  
  // Relations pour les liens inline
  linksFrom InlineReference[] @relation("SourceCard")
  linksTo   InlineReference[] @relation("TargetCard")
  
  // Relations pour les raccourcis et partages
  shortcuts CardShortcut[]
  shares    SharedResource[]

  @@map("knowledge_cards")
  @@index([userId])
  @@index([userId, createdAt])
  @@index([folderId])
}

model KnowledgeSection {
  id              String   @id @default(uuid())
  title           String
  content         String
  contentType     String   @default("text")
  order           Int      @default(0)
  knowledgeCardId String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  knowledgeCard   KnowledgeCard @relation(fields: [knowledgeCardId], references: [id], onDelete: Cascade)
  
  // Relations pour les liens inline
  linksFrom InlineReference[] @relation("SourceSection")
  linksTo   InlineReference[] @relation("TargetSection")

  @@map("knowledge_sections")
  @@index([knowledgeCardId])
  @@index([knowledgeCardId, order])
}

// Table pour stocker les liens inline entre fiches/sections
model InlineReference {
  id        String   @id @default(uuid())
  
  // Source du lien (où est le texte surligné)
  sourceCardId    String
  sourceSectionId String?
  
  // Cible du lien (fiche/section référencée)
  targetCardId    String
  targetSectionId String?
  
  // Texte surligné
  highlightedText String
  
  // Métadonnées
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  sourceCard    KnowledgeCard     @relation("SourceCard", fields: [sourceCardId], references: [id], onDelete: Cascade)
  sourceSection KnowledgeSection? @relation("SourceSection", fields: [sourceSectionId], references: [id], onDelete: Cascade)
  targetCard    KnowledgeCard     @relation("TargetCard", fields: [targetCardId], references: [id], onDelete: Cascade)
  targetSection KnowledgeSection? @relation("TargetSection", fields: [targetSectionId], references: [id], onDelete: Cascade)

  @@map("inline_references")
  @@index([sourceCardId])
  @@index([sourceSectionId])
  @@index([targetCardId])
  @@index([targetSectionId])
  @@index([sourceCardId, targetCardId])
}

// Modèles pour les templates de sections
model SectionTemplate {
  id        String   @id @default(uuid())
  name      String
  userId    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  items     SectionTemplateItem[]

  @@map("section_templates")
  @@index([userId])
}

model SectionTemplateItem {
  id                String   @id @default(uuid())
  sectionTemplateId String
  title             String
  content           String
  contentType       String   @default("editorjs")
  order             Int      @default(0)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  template          SectionTemplate @relation(fields: [sectionTemplateId], references: [id], onDelete: Cascade)

  @@map("section_template_items")
  @@index([sectionTemplateId])
  @@index([sectionTemplateId, order])
}

// Modèle pour les raccourcis vers des fiches dans les dossiers
model CardShortcut {
  id        String   @id @default(uuid())
  folderId  String
  cardId    String
  order     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  folder    Folder        @relation(fields: [folderId], references: [id], onDelete: Cascade)
  card      KnowledgeCard @relation(fields: [cardId], references: [id], onDelete: Cascade)

  @@map("card_shortcuts")
  @@index([folderId])
  @@index([cardId])
  @@index([folderId, order])
  @@unique([folderId, cardId])
}

model Group {
  id        String   @id @default(uuid())
  name      String
  ownerId   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  owner           User             @relation("GroupOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  members         GroupMember[]
  sharedResources SharedResource[]
  invitations     Invitation[]

  @@map("groups")
}

model GroupMember {
  id       String   @id @default(uuid())
  groupId  String
  userId   String
  role     String   @default("MEMBER") // ADMIN, MEMBER
  joinedAt DateTime @default(now())

  group Group @relation(fields: [groupId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([groupId, userId])
  @@map("group_members")
}

model SharedResource {
  id String @id @default(uuid())

  folderId String?
  cardId   String?

  sharedWithUserId  String?
  sharedWithGroupId String?

  permissions String   @default("READ") // READ, WRITE
  createdAt   DateTime @default(now())

  folder Folder?        @relation(fields: [folderId], references: [id], onDelete: Cascade)
  card   KnowledgeCard? @relation(fields: [cardId], references: [id], onDelete: Cascade)

  user  User?  @relation(fields: [sharedWithUserId], references: [id], onDelete: Cascade)
  group Group? @relation(fields: [sharedWithGroupId], references: [id], onDelete: Cascade)

  @@map("shared_resources")
  @@index([folderId])
  @@index([cardId])
  @@index([sharedWithUserId])
  @@index([sharedWithGroupId])
}

model Invitation {
  id           String    @id @default(uuid())
  email        String
  token        String    @unique
  type         String // GROUP_INVITE, RESOURCE_SHARE
  resourceType String? // FOLDER, CARD (only if type is RESOURCE_SHARE)
  resourceId   String? // (only if type is RESOURCE_SHARE)
  groupId      String? // (only if type is GROUP_INVITE)
  senderId     String
  status       String    @default("PENDING") // PENDING, ACCEPTED, EXPIRED
  permissions  String? // READ, WRITE (for resource sharing)
  createdAt    DateTime  @default(now())
  expiresAt    DateTime

  sender User   @relation("SentInvitations", fields: [senderId], references: [id], onDelete: Cascade)
  group  Group? @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@map("invitations")
  @@index([email])
  @@index([token])
}